# Testando cria√ß√£o de projeto via API

Nesta aula, teu desafio √© testar o cen√°rio de cria√ß√£o de projeto (via API) com sucesso.

## Exerc√≠cio 1 - Cria√ß√£o de projeto via API

Crie um teste automatizado que exercita a funcionalidade de cria√ß√£o de projeto via _Application Programming Interface (API)_.

### Informa√ß√µes √∫teis sobre a API

- O _endpoint_ para cria√ß√£o de projetos √© `/api/v4/projects/`
- O verbo para cria√ß√£o de projetos √© o `POST`
- Os atributos que devem ser passados no `body` da requisi√ß√£o s√£o: `name` (String), `description` (String) e `initialize_with_readme` (Boolean)
- Um token de autorizac√£o (`Authorization`) deve ser passado nos `headers`, prefixado por `Bearer`
- Ap√≥s a cria√ß√£o do projeto com sucesso, o status da resposta da requisi√ß√£o deve ser `201`.

<details><summary>Em caso de d√∫vidas, abra para ver o passo-a-passo</summary>
</br>

1. Dentro do diret√≥rio `cypress/e2e/`, crie um novo diret√≥rio chamado `api/`

2. Dentro do diretr√≥rio `cypress/e2e/api/`, crie um arquivo chamado `createProject.cy.js` com os seguintes dados:

```js
import { faker } from '@faker-js/faker'

describe('Create Project', () => {
  it('successfully', () => {
    const project = {
      name: `project-${faker.datatype.uuid()}`,
      description: faker.random.words(5)
    }

    cy.api_createProject(project)
      .then(response => {
        expect(response.status).to.equal(201)
        expect(response.body.name).to.equal(project.name)
        expect(response.body.description).to.equal(project.description)
      })
  })
})

```

3. Dentro do diret√≥rio `cypress/support/`, crie um arquivo chamado `api_commands.js`, com os seguintes dados:

```js
const accessToken = `Bearer ${Cypress.env('gitlab_access_token')}`

Cypress.Commands.add('api_createProject', project => {
  cy.request({
    method: 'POST',
    url: `/api/v4/projects/`,
    body: {
      name: project.name,
      description: project.description,
      initialize_with_readme: true
    },
    headers: { Authorization: accessToken },
  })
})

```

4. Dentro do diret√≥rio `cypress/support/`, adicione ao arquivo `e2e.js` o import do arquivo `api_commands.js`, conforme abaixo:

```js
import './api_commands'
import './gui_commands'

```

5. Por fim, via Cypress App, execute o teste `cypress/e2e/api/createProject.cy.js`.

> Perceba como a cria√ß√£o de projeto via API √© muito mais r√°pida.
>
> Por√©m, sempre que este, ou os testes `cypress/e2e/gui/createProject.cy.js` e `cypress/e2e/gui/createIssue.cy.js` s√£o executados, deixamos "lixo" para tr√°s.
>
> Ou seja, projetos que s√£o criados para fins de testes, os quais nunca s√£o deletados.
>
> üë®‚Äçüè´ Vamos resolver isso?

</details>

## Exerc√≠cio 2 - Limpeza de dados

Crie um mecanismo para a limpeza de projetos criados anteriomente, de forma que todos os testes que criem tal recurso possam iniciar em um estado "limpo".

### Informa√ß√µes √∫teis sobre a API

- O _endpoint_ para busca de todos os projetos √© `/api/v4/projects/`
- O _endpoint_ para a dele√ß√£o de projetos √© `/api/v4/projects/:projectId`
- O verbo para busca de projetos √© o `GET`
- O verbo para dele√ß√£o de projetos √© o `DELETE`
- Para ambos os _endpoints_, um token de autorizac√£o (`Authorization`) deve ser passado nos `headers`, prefixado por `Bearer`

<details><summary>Em caso de d√∫vidas, abra para ver o passo-a-passo</summary>
</br>

1. No arquivo `cypress/support/api_commands.js`, adicione os comandos `api_getAllProjects` e `api_deleteProjects`, conforme demonstrado abaixo:

```js

const accessToken = `Bearer ${Cypress.env('gitlab_access_token')}`

Cypress.Commands.add('api_createProject', project => {
  ...
})

Cypress.Commands.add('api_getAllProjects', () => {
  cy.request({
    method: 'GET',
    url: '/api/v4/projects/',
    headers: { Authorization: accessToken },
  })
})

Cypress.Commands.add('api_deleteProjects', () => {
  cy.api_getAllProjects().then(res =>
    res.body.forEach(project => cy.request({
      method: 'DELETE',
      url: `/api/v4/projects/${project.id}`,
      headers: { Authorization: accessToken },
    }))
  )
})

```


2. Agora, no arquivo `cypress/e2e/api/createProject.cy.js`, adicione a fun√ß√£o `beforeEach`, chamando o comando customizado `cy.api_deleteProjects()` em sua fun√ß√£o de _callback_, conforme abaixo:

```js
import { faker } from '@faker-js/faker'

describe('Create issue', () => {
  beforeEach(() => cy.api_deleteProjects())

  it('successfully', () => {
    ...
  })
})

```

3. Via Cypress App, execute novamente o teste `cypress/e2e/api/createProject.cy.js` e verifique a limpeza dos projetos criados anteriormente acontecendo

> Acesse o ambiente local e veja que s√≥ um projeto deve estar dispon√≠vel ap√≥s a execu√ß√£o do teste, visto que todos os outros foram limpos antes da execu√ß√£o.

4. Nos arquivos `cypress/e2e/gui/createProject.cy.js` e `cypress/e2e/gui/createIssue.cy.js`, adicione tamb√©m a chamada ao comando customizado `cy.api_deleteProjects()` antes da chamada do comando `cy.login()`, garantindo que testes de _GUI_ tamb√©m n√£o est√£o deixando "lixo" para tr√°s

5. Execute ambos os testes via Cypress App para garantir que ambos continuam funcionando.

</details>

## Exerc√≠cio 3 - Otimizando o de cria√ß√£o de _issue_ via _GUI_

Agora que podemos criar projetos via API, atualize o teste de cria√ß√£o de _issue_ via _GUI_ (visto que este depende de tal recurso somente como uma pr√©-condi√ß√£o), para que tal teste seja o mais otimizado poss√≠vel, passando pela _GUI_ s√≥ para o que for realmente necess√°rio, sem a necessidade de _over testing_ (testar mais do que necess√°rio).

<details><summary>Em caso de d√∫vidas, abra para ver o passo-a-passo</summary>
</br>

1. Agora que podemos criar um projeto via API, altere o arquivo `cypress/e2e/gui/createIssue.cy.js`, para em vez de criar o projeto com o comando customizado `cy.gui_createProject(issue.project)`, use o comando `cy.api_createProject(issue.project)`

2. Via Cypress App, execute o arquivo `cypress/e2e/gui/createIssue.cy.js`.

> Perceba que agora, al√©m do processo de _login_, a cria√ß√£o de projeto (que √© s√≥ uma pr√©-condi√ß√£o do teste) tamb√©m est√° otimizada, ocorrendo via uma chamada de API.
>
> Ou seja, um processo muito mais r√°pido do que criar um projeto via _GUI_.
>
> Al√©m disso, a funcionalidade de cria√ß√£o projeto via _GUI_ j√° est√° coberta por outro teste, portanto, fazer isso de novo via _GUI_ era um desperd√≠cio.

</details>

## Exerc√≠cio 4 - Feedback visual dos testes de API

Configure o plugin [`cypress-plugin-api`](https://www.npmjs.com/package/cypress-plugin-api) (instalado na aula 1), para que tenhamos _feedback_ visual quando estivermos executando os testes de API.

<details><summary>Em caso de d√∫vidas, abra para ver o passo-a-passo</summary>
</br>

Na [aula 1](./1.md), al√©m de instalarmos o `cypress` e o `faker`, instalmos tamb√©m a _lib_ `cypress-plugin-api`.

Com ela, √© possivel ter _feedback_ visual durante a execu√ß√£o de testes de API.

1. Altere o arquivo `cypress/support/e2e.js` conforme abaixo:

```js
import 'cypress-plugin-api'

import './api_commands'
import './gui_commands'

```

2. Altere o arquivo `cypress.config.js` conforme abaixo:

```js
const { defineConfig } = require('cypress')

module.exports = defineConfig({
  e2e: {
    baseUrl: 'http://localhost',
    env: {
      hideCredentials: true,
      requestMode: true,
    },
  },
  fixturesFolder: false,
  video: false,
})

```

3. Via Cypress App, execute de novo o arquivo `cypress/e2e/api/createProject.cy.js`.

> Veja que agora, temos um _feedback_ visual do que est√° ocorrendo √† n√≠vel de chamadas de API. Fant√°stico, n√£o acha?
>
> Perceba tamb√©m que, o token de acesso (o qual √© um dados sens√≠vel) est√° protegido üîí, visto que estamos usando a op√ß√£o `hideCredential: true`, como vari√°vel dos testes e2e no arquivo de configura√ß√£o.
>
> Por fim, estamos usando a op√ß√£o `requestMode: true`, tamb√©m como vari√°vel dos testes e2e no arquivo de configura√ß√£o para que tal _feedback_ visual ocorra mesmo que estejamos utilizando o comando `cy.request()`, visto que por padr√£o, tal _feedback_ visual s√≥ √© dispon√≠vel para o comando `cy.api()`, disponibilizado pela _lib_ `cypress-plugin-api`.

</details>

## Exerc√≠cio 5 - Feedback visual dos testes de GUI com API

Al√©m de _feedback_ visual para testes de API, a _lib_ `cypress-plugin-api` possibilita combinar testes de API com os testes de _GUI_. Leia sobre a funcionalidade [`snapshot only mode`](https://www.npmjs.com/package/cypress-plugin-api#snapshot-only-mode) para mais detalhes.

Teu exerc√≠cio √© fazer uso dessa funcionalidade (`snapshot only mode`), para que nos testes de _GUI_, tamb√©m tenhamos _feedback_ visual quando chamadas de API estiverem rodando, ou quando estivermos utilizando a funcionalidade de [_time-traveling_](https://docs.cypress.io/guides/core-concepts/cypress-app#Time-traveling) do Cypress.

<details><summary>Em caso de d√∫vidas, abra para ver o passo-a-passo</summary>
</br>

1. Adicione √† fun√ß√£o `describe` do arquivo `cypress/e2e/gui/createProject.cy.js` (entre a descri√ß√£o do teste e a fun√ß√£o de _callback_), um objeto, conforme demonstrado abaixo:

```js
import { faker } from '@faker-js/faker'

const options = { env: { snapshotOnly: true } }

describe('Create Project', options, () => {
  ...
})

```

2. Fa√ßa o mesmo para o arquivo `cypress/e2e/gui/createIssue.cy.js`, conforme demonstrado abaixo:

```js
import { faker } from '@faker-js/faker'

const options = { env: { snapshotOnly: true } }

describe('Create Issue', options, () => {
  ...
})


```

3. Via Cypress App, execute ambos os testes e utilize a funcionalidade de _time travel_ para voltar aos passos onde as requisi√ß√µes de API foram executadas para ter o _feedback_ visual de tais chamadas com a ajuda da _lib_ `cypress-plugin-api`. Al√©m disso, tenha tamb√©m as _snapshots_ da aplica√ß√£o em teste, quando executando comandos via _GUI_.

</details>

___

V√° para a [aula 7](./7.md) para testarmos a funcionalidade de cria√ß√£o de _issue_, tamb√©m via chamadas de API.
